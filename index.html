<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extract Frames and Audio from MP4</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@latest/dist/ffmpeg.min.js"></script>
</head>
<body>
    <input type="file" id="fileInput" accept="video/mp4">
    <video id="video" controls style="display:none;"></video>
    <canvas id="canvas"></canvas>
    <button id="processVideo">Extract Frames and Audio</button>
    <button id="downloadZip" style="display:none;">Download ZIP</button>
    <div id="status"></div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const processVideoButton = document.getElementById('processVideo');
        const downloadZipButton = document.getElementById('downloadZip');
        const statusDiv = document.getElementById('status');

        let frames = [];
        let audioBlob;

        fileInput.addEventListener('change', handleFileSelect);

        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                video.src = URL.createObjectURL(file);
                video.addEventListener('loadeddata', () => {
                    video.play();
                });
            }
        }

        processVideoButton.addEventListener('click', async () => {
            if (video.readyState >= 2) { // Check if video metadata is loaded
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                // Extract frames at 30 FPS
                const fps = 30;
                const interval = 1000 / fps;
                const duration = video.duration;
                const totalFrames = Math.floor(duration * fps);
                
                statusDiv.textContent = `Extracting ${totalFrames} frames...`;
                
                for (let i = 0; i < totalFrames; i++) {
                    video.currentTime = i / fps;
                    await new Promise(resolve => video.addEventListener('seeked', resolve, { once: true }));
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    // Convert canvas to PNG data URL and store in frames array
                    const imgData = canvas.toDataURL('image/png');
                    frames.push(imgData);
                }

                // Extract audio using ffmpeg.js
                const { createFFmpeg, fetchFile } = FFmpeg;
                const ffmpeg = createFFmpeg({ log: true });
                await ffmpeg.load();
                ffmpeg.FS('writeFile', 'input.mp4', await fetchFile(file));
                await ffmpeg.run('-i', 'input.mp4', '-q:a', '0', '-map', 'a', 'output.mp3');
                audioBlob = new Blob([ffmpeg.FS('readFile', 'output.mp3')], { type: 'audio/mpeg' });

                // Show download button
                downloadZipButton.style.display = 'block';
                statusDiv.textContent = `Extraction complete. ${frames.length} frames and audio ready.`;
            } else {
                alert('Video is not ready');
            }
        });

        downloadZipButton.addEventListener('click', async () => {
            if (frames.length === 0) {
                alert('No frames to download.');
                return;
            }

            const zip = new JSZip();
            const folder = zip.folder("frames");

            // Add frames to ZIP
            for (let i = 0; i < frames.length; i++) {
                const imgData = frames[i];
                const data = imgData.replace(/^data:image\/png;base64,/, '');
                folder.file(`frame${i + 1}.png`, data, { base64: true });
            }

            // Add audio to ZIP
            zip.file('audio.mp3', audioBlob);

            // Generate ZIP file
            const zipContent = await zip.generateAsync({ type: "blob" });
            saveAs(zipContent, "media.zip");
        });
    </script>
</body>
</html>
