<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extract Frames from MP4</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@latest/dist/ffmpeg.min.js"></script>
</head>
<body>
    <input type="file" id="fileInput" accept="video/mp4">
    <video id="video" style="display:none;" muted></video>
    <canvas id="canvas"></canvas>
    <button id="processVideo">Extract Frames and Audio</button>
    <button id="downloadZip" style="display:none;">Download ZIP</button>
    <div id="status"></div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const processVideoButton = document.getElementById('processVideo');
        const downloadZipButton = document.getElementById('downloadZip');
        const statusDiv = document.getElementById('status');

        let frames = [];
        let audioBlob;

        fileInput.addEventListener('change', handleFileSelect);

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                video.src = URL.createObjectURL(file);
                video.addEventListener('loadeddata', () => {
                    // Ensure the video is not playing or visible
                    video.pause();
                    video.currentTime = 0;
                });
            }
        }

        processVideoButton.addEventListener('click', async () => {
            if (video.readyState >= 2) { // Check if video metadata is loaded
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;

                const fps = 30;
                const interval = 1000 / fps;
                const duration = video.duration;
                const totalFrames = Math.floor(duration * fps);

                statusDiv.textContent = `Extracting ${totalFrames} frames...`;

                // Process frames in parallel
                const framePromises = [];
                for (let i = 0; i < totalFrames; i++) {
                    const currentTime = i / fps;
                    framePromises.push(extractFrameAtTime(currentTime, i));
                }
                await Promise.all(framePromises);

                // Extract audio using ffmpeg.js
                const { createFFmpeg, fetchFile } = FFmpeg;
                const ffmpeg = createFFmpeg({ log: true });
                await ffmpeg.load();
                ffmpeg.FS('writeFile', 'input.mp4', await fetchFile(file));
                await ffmpeg.run('-i', 'input.mp4', '-q:a', '0', '-map', 'a', 'output.mp3');
                audioBlob = new Blob([ffmpeg.FS('readFile', 'output.mp3')], { type: 'audio/mpeg' });

                // Show download button
                downloadZipButton.style.display = 'block';
                statusDiv.textContent = `Extraction complete. ${frames.length} frames and audio ready.`;
            } else {
                alert('Video is not ready');
            }
        });

        async function extractFrameAtTime(currentTime, index) {
            return new Promise((resolve) => {
                video.currentTime = currentTime;
                video.addEventListener('seeked', function onSeeked() {
                    video.removeEventListener('seeked', onSeeked);
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    const imgData = canvas.toDataURL('image/png');
                    frames[index] = imgData;
                    resolve();
                });
            });
        }

        downloadZipButton.addEventListener('click', async () => {
            if (frames.length === 0) {
                alert('No frames to download.');
                return;
            }

            const zip = new JSZip();
            const folder = zip.folder("frames");

            // Add frames to ZIP
            frames.forEach((imgData, i) => {
                const data = imgData.replace(/^data:image\/png;base64,/, '');
                folder.file(`frame${i + 1}.png`, data, { base64: true });
            });

            // Add audio to ZIP
            zip.file('audio.mp3', audioBlob);

            // Generate ZIP file
            const zipContent = await zip.generateAsync({ type: "blob" });
            saveAs(zipContent, "media.zip");
        });
    </script>
</body>
</html>
